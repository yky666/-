#!/usr/bin/env python3
# -*- coding: utf-8 -*
 
import  os
import  sys
import  tty, termios
import roslib
import rospy
from geometry_msgs.msg import Twist
 
# È«¾Ö±äÁ¿
cmd = Twist()
pub = rospy.Publisher('cmd_vel', Twist, queue_size=1)

def keyboardLoop():
    rospy.init_node('teleop')
    #³õÊ¼»¯¼àÌý¼üÅÌ°´Å¥Ê±¼ä¼ä¸ô
    rate = rospy.Rate(rospy.get_param('~hz', 10))
 
    #ËÙ¶È±äÁ¿
    # ÂýËÙ
    walk_vel_ = rospy.get_param('walk_vel', 0.1)
    # ¿ìËÙ
    yaw_rate_ = rospy.get_param('yaw_rate', 0.5)
    # walk_vel_Ç°ºóËÙ¶È
    max_tv = walk_vel_
    # yaw_rate_Ðý×ªËÙ¶È
    max_rv = yaw_rate_
    # ²ÎÊý³õÊ¼»¯
    speed=0
    # global can_release,can_grasp
    # can_grasp=True
    # can_release=False
    
    print ("Ê¹ÓÃ[WASD][QEZC]¿ØÖÆ»úÆ÷ÈË")
    print ("°´[F]ÍË³ö" )
    #¶ÁÈ¡°´¼üÑ­»·
    while not rospy.is_shutdown():
        # linuxÏÂ¶ÁÈ¡¼üÅÌ°´¼ü
        fd = sys.stdin.fileno()
        turn =0
        old_settings = termios.tcgetattr(fd)
        #²»²úÉú»ØÏÔÐ§¹û
        old_settings[3] = old_settings[3] & ~termios.ICANON & ~termios.ECHO
        try :
            tty.setraw( fd )
            ch = sys.stdin.read( 1 )
        finally :
            termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
        # ch´ú±í»ñÈ¡µÄ¼üÅÌ°´¼ü
        if ch == 'w':
            max_tv = walk_vel_
            speed = 1
            turn = 0
        elif ch == 's':
            max_tv = walk_vel_
            speed = -1
            turn = 0
        elif ch == 'a':
            max_rv = yaw_rate_
            speed = 0
            turn = 1
        elif ch == 'd':
            max_rv = yaw_rate_
            speed = 0
            turn = -1
            elif ch == 'q':
            max_tv = walk_vel_
            max_rv = yaw_rate_
            speed = 1
            turn = 1
        elif ch == 'e':
            max_tv = walk_vel_
            max_rv = yaw_rate_
            speed = 1
            turn = -1
        elif ch == 'z':
            max_tv = walk_vel_
            max_rv = yaw_rate_
            speed = -1
            turn = -1
        elif ch == 'c':
            max_tv = walk_vel_
            max_rv = yaw_rate_
            speed = -1
            turn = 1

        elif ch == 'f':
            exit()
        else:
            max_tv = walk_vel_
            max_rv = yaw_rate_
            speed = 0
            turn = 0

        #·¢ËÍÏûÏ¢
        cmd.linear.x = speed * max_tv
        cmd.angular.z = turn * max_rv
        pub.publish(cmd)
        rate.sleep()
        #Í£Ö¹»úÆ÷ÈË
        #stop_robot()
        
        def stop_robot():
    cmd.linear.x = 0.0
    cmd.angular.z = 0.0
    pub.publish(cmd)
 
if __name__ == '__main__':
    try:
        keyboardLoop()
    except rospy.ROSInterruptException:
        pass
